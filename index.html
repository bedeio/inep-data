<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Escolas do Brasil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Tom Select (searchable selects) -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }

    #toolbar {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: .75rem;
      padding: .75rem;
      border-bottom: 1px solid #ddd;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif;
      background: #fff;
    }

    fieldset { border: 1px solid #ddd; border-radius: 8px; padding: .5rem .75rem; }
    fieldset legend { font-weight: 600; padding: 0 .25rem; }
    label { display: block; margin: .25rem 0; }

    select, input[type="text"], input[type="file"] {
      width: 100%; padding: .35rem .5rem; border: 1px solid #ccc; border-radius: 6px; background: #fff;
    }

    .btn { display:inline-block; padding:.45rem .65rem; border-radius:8px; border:1px solid #ccc; background:#f8f8f8; cursor:pointer; }
    .btn:hover { background:#f0f0f0; }

    #progress { font-size: 12px; color: #555; align-self: center; }
    #counts { font-size: 12px; color: #666; }

    #filters fieldset { margin: 0; }
    #filters .filters-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: .75rem;
    }
    .group { border: 1px solid #eee; border-radius: 8px; padding: .5rem; }
    .group h4 { margin: 0 0 .5rem 0; font-size: 13px; color:#333; }

    .checks {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap:.25rem .6rem; max-height: 180px; overflow: auto;
      border:1px solid #eee; border-radius:8px; padding:.35rem;
      background: #fff;
    }
    .checks label { display:flex; gap:.35rem; align-items:center; margin:0; }

    .row-inline { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }

    /* 3 columns for atributos to reduce height */
    .three-cols { display:grid; grid-template-columns: repeat(3, 1fr); gap:.5rem .75rem; }

    #map { width: 100%; height: 100%; }

    .ts-wrapper.single .ts-control, .ts-wrapper .ts-control { min-height: 34px; }

    .popup table { border-collapse: collapse; }
    .popup th { text-align:left; padding:2px 6px; color:#333; }
    .popup td { padding:2px 6px; color:#222; }
  </style>
</head>
<body>
<div id="app">
  <div id="toolbar">
    <!-- Left column: Data load + Location filters + progress -->
    <div>
      <fieldset>
        <legend>1) Carregar dados</legend>
        <label>CSV de escolas:
          <input type="file" id="csvFile" accept=".csv,text/csv" />
        </label>
        <div class="row-inline" style="margin-top:.5rem;">
          <button class="btn" id="exportCsv" disabled>Exportar filtrados (CSV)</button>
          <div id="counts"></div>
        </div>
      </fieldset>

      <fieldset style="margin-top:.5rem;">
        <legend>Localização</legend>
        <label>Região
          <select id="filterRegiao">
            <option value="">(todas)</option>
            <option>Norte</option>
            <option>Nordeste</option>
            <option>Centro-Oeste</option>
            <option>Sudeste</option>
            <option>Sul</option>
          </select>
        </label>

        <label>UF (OR — marque uma ou mais)
          <div id="checksUF" class="checks" style="max-height:140px;"></div>
        </label>

        <label>Município
          <select id="filterMunicipio"><option value="">(todos)</option></select>
        </label>
      </fieldset>

      <div id="progress" style="margin-top:.5rem;">Selecione um CSV para começar.</div>
    </div>

    <!-- Right column: Attribute filters -->
    <div id="filters">
      <fieldset>
        <legend>Atributos</legend>
        <div class="three-cols">
          <div>
            <label>Categoria Administrativa
              <select id="filterCategoriaAdm"><option value="">(todas)</option></select>
            </label>
            <label>Localização
              <select id="filterLocalizacao"><option value="">(todas)</option></select>
            </label>
            <label>Localidade Diferenciada
              <select id="filterLocDif"><option value="">(todas)</option></select>
            </label>
            <label>Restrição de Atendimento
              <select id="filterRestricao"><option value="">(todas)</option></select>
            </label>
          </div>

          <div>
            <label>Dependência Administrativa
              <select id="filterDepAdm"><option value="">(todas)</option></select>
            </label>
            <label>Categoria Escola Privada
              <select id="filterCatPriv"><option value="">(todas)</option></select>
            </label>
            <label>Conveniada Poder Público
              <select id="filterConveniada"><option value="">(todas)</option></select>
            </label>
            <label>Regulamentação pelo Conselho de Educação
              <select id="filterRegul"><option value="">(todas)</option></select>
            </label>
          </div>

          <div>
            <label>Porte da Escola
              <select id="filterPorte"><option value="">(todos)</option></select>
            </label>
            <label>Busca (texto livre)
              <input type="text" id="filterText" placeholder="buscar em todas as colunas…" />
            </label>
            <div class="row-inline" style="margin-top:.25rem;">
              <button class="btn" id="applyFilters" disabled>Aplicar</button>
              <button class="btn" id="clearFilters" disabled>Limpar</button>
            </div>
          </div>
        </div>

        <div style="margin-top:.5rem;">
          <div><strong>Etapas e Modalidade (OR — marque uma ou mais)</strong></div>
          <div id="checksEtapas" class="checks" style="max-height:140px;"></div>
        </div>

        <div style="margin-top:.5rem;">
          <div><strong>Outras Ofertas (OR — marque uma ou mais)</strong></div>
          <div id="checksOfertas" class="checks" style="max-height:140px;"></div>
        </div>
      </fieldset>
    </div>
  </div>

  <div id="map"></div>
</div>

<!-- Inline web worker (no raw-string JS in the main script) -->
<script id="filter-worker" type="javascript/worker">
let DATA = [];
let UF_INFO = null;

self.onmessage = (e) => {
  const { type } = e.data;

  if (type === 'config') {
    UF_INFO = e.data.ufInfo || {};
    return;
  }

  if (type === 'load') {
    DATA = e.data.preproc || [];
    self.postMessage({ type: 'loaded' });
    return;
  }

  if (type === 'filter') {
    const c = e.data.criteria;
    const q = (c.text || '').toLowerCase();
    const selUF = c.uf || [];                    // array of UF codes (upper)
    const etapasSel = new Set(c.etapas || []);   // OR
    const ofertasSel = new Set(c.ofertas || []); // OR

    const out = [];
    for (let i = 0; i < DATA.length; i++) {
      const r = DATA[i];

      if (c.regiao) {
        const info = UF_INFO[r.ufUpper];
        const reg = info ? info.reg : '';
        if (reg !== c.regiao) continue;
      }

      // UF OR logic — if none selected, accept all
      if (selUF.length && !selUF.includes(r.ufUpper)) continue;

      if (c.municipio && r.municipio !== c.municipio) continue;
      if (c.catAdm && r.catAdm !== c.catAdm) continue;
      if (c.localizacao && r.localizacao !== c.localizacao) continue;
      if (c.locDif && r.locDif !== c.locDif) continue;

      if (c.restricao && r.restricao !== c.restricao) continue;
      if (c.depAdm && r.depAdm !== c.depAdm) continue;
      if (c.catPriv && r.catPriv !== c.catPriv) continue;
      if (c.conveniada && r.conveniada !== c.conveniada) continue;
      if (c.regul && r.regul !== c.regul) continue;
      if (c.porte && r.porte !== c.porte) continue;

      // OR semantics (no normalization)
      if (etapasSel.size) {
        let hit = false;
        for (const t of r.etapasArr) { if (etapasSel.has(t)) { hit = true; break; } }
        if (!hit) continue;
      }
      if (ofertasSel.size) {
        let hit = false;
        for (const t of r.ofertasArr) { if (ofertasSel.has(t)) { hit = true; break; } }
        if (!hit) continue;
      }

      if (q && !r.search.includes(q)) continue;

      out.push(i);
    }
    self.postMessage({ type: 'filtered', idx: out });
  }
};
</script>

<script>
  /***********************
   * SIMPLE CONFIG
   ***********************/
  const CHUNK_SIZE_ADD = 2000;   // markers per batch when adding to map
  const BRAZIL_CENTER = [-14.235, -51.925];

  /***********************
   * COLUMN MAP
   ***********************/
  const COLS = {
    restricao: "Restrição de Atendimento",
    escola: "Escola",
    inep: "Código INEP",
    uf: "UF",
    municipio: "Município",
    localizacao: "Localização",
    locDif: "Localidade Diferenciada",
    catAdm: "Categoria Administrativa",
    endereco: "Endereço",
    telefone: "Telefone",
    depAdm: "Dependência Administrativa",
    catPriv: "Categoria Escola Privada",
    conveniada: "Conveniada Poder Público",
    regul: "Regulamentação pelo Conselho de Educação",
    porte: "Porte da Escola",
    etapas: "Etapas e Modalidade de Ensino Oferecidas",
    ofertas: "Outras Ofertas Educacionais",
    lat: "Latitude",
    lon: "Longitude",
  };

  // UF -> Região + centro aproximado (fallback coords)
  const UF_INFO = {
    AC:{reg:"Norte",        c:[-9.023,  -70.812]},
    AL:{reg:"Nordeste",     c:[-9.571,  -36.782]},
    AM:{reg:"Norte",        c:[-3.416,  -65.856]},
    AP:{reg:"Norte",        c:[0.902,   -52.003]},
    BA:{reg:"Nordeste",     c:[-12.969, -41.392]},
    CE:{reg:"Nordeste",     c:[-5.498,  -39.320]},
    DF:{reg:"Centro-Oeste", c:[-15.799, -47.864]},
    ES:{reg:"Sudeste",      c:[-19.183, -40.308]},
    GO:{reg:"Centro-Oeste", c:[-15.827, -49.836]},
    MA:{reg:"Nordeste",     c:[-5.420,  -45.444]},
    MG:{reg:"Sudeste",      c:[-18.512, -44.555]},
    MS:{reg:"Centro-Oeste", c:[-20.772, -54.785]},
    MT:{reg:"Centro-Oeste", c:[-12.681, -55.636]},
    PA:{reg:"Norte",        c:[-3.790,  -52.480]},
    PB:{reg:"Nordeste",     c:[-7.239,  -36.780]},
    PE:{reg:"Nordeste",     c:[-8.380,  -37.860]},
    PI:{reg:"Nordeste",     c:[-7.718,  -42.728]},
    PR:{reg:"Sul",          c:[-24.891, -51.555]},
    RJ:{reg:"Sudeste",      c:[-22.250, -42.660]},
    RN:{reg:"Nordeste",     c:[-5.402,  -36.954]},
    RO:{reg:"Norte",        c:[-10.830, -63.340]},
    RR:{reg:"Norte",        c:[2.737,   -62.075]},
    RS:{reg:"Sul",          c:[-30.034, -53.000]},
    SC:{reg:"Sul",          c:[-27.242, -50.218]},
    SE:{reg:"Nordeste",     c:[-10.574, -37.385]},
    SP:{reg:"Sudeste",      c:[-22.190, -48.790]},
    TO:{reg:"Norte",        c:[-10.175, -48.298]},
  };

  /***********************
   * MAP
   ***********************/
  const map = L.map('map', { preferCanvas: true });
  map.setView(BRAZIL_CENTER, 5); // Focus Brasil

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const cluster = L.markerClusterGroup({
    chunkedLoading: true, chunkDelay: 0, chunkInterval: 200,
    disableClusteringAtZoom: 15, spiderfyOnMaxZoom: true, showCoverageOnHover: false
  });
  map.addLayer(cluster);

  /***********************
   * STATE
   ***********************/
  let allRows = [];
  let preproc = [];
  let filteredIdx = [];

  /***********************
   * UI
   ***********************/
  const progressEl  = document.getElementById('progress');
  const countsEl    = document.getElementById('counts');
  const exportBtn   = document.getElementById('exportCsv');

  const csvFile   = document.getElementById('csvFile');

  const selects = {
    regiao:    document.getElementById('filterRegiao'),
    municipio: document.getElementById('filterMunicipio'),
    catAdm:    document.getElementById('filterCategoriaAdm'),
    localizacao: document.getElementById('filterLocalizacao'),
    locDif:    document.getElementById('filterLocDif'),
    restricao: document.getElementById('filterRestricao'),
    depAdm:    document.getElementById('filterDepAdm'),
    catPriv:   document.getElementById('filterCatPriv'),
    conveniada:document.getElementById('filterConveniada'),
    regul:     document.getElementById('filterRegul'),
    porte:     document.getElementById('filterPorte'),
  };
  const txtSearch = document.getElementById('filterText');
  const btnApply  = document.getElementById('applyFilters');
  const btnClear  = document.getElementById('clearFilters');

  const checksUF      = document.getElementById('checksUF');
  const checksEtapas  = document.getElementById('checksEtapas');
  const checksOfertas = document.getElementById('checksOfertas');

  // Tom Select (searchable selects)
  const ts = {};
  function initTomSelect(el, placeholder="(todas)") {
    if (ts[el.id]) return ts[el.id];
    ts[el.id] = new TomSelect(el, {
      allowEmptyOption: true,
      create: false,
      maxOptions: 1000,
      sortField: {field:'text', direction:'asc'},
      placeholder,
      plugins: ['clear_button'],
    });
    return ts[el.id];
  }
  initTomSelect(selects.regiao, "(todas)");
  initTomSelect(selects.municipio, "(todos)");
  initTomSelect(selects.catAdm);
  initTomSelect(selects.localizacao);
  initTomSelect(selects.locDif);
  initTomSelect(selects.restricao);
  initTomSelect(selects.depAdm);
  initTomSelect(selects.catPriv);
  initTomSelect(selects.conveniada);
  initTomSelect(selects.regul);
  initTomSelect(selects.porte, "(todos)");

  const setProgress = (t) => progressEl.textContent = t || '';
  const esc = (v) => (v == null ? '' : String(v));

  function formatPopup(row) {
    const order = Object.values(COLS);
    const rows = order.map(label => `<tr><th>${label}</th><td>${esc(row[label])}</td></tr>`).join('');
    return `<div class="popup"><table>${rows}</table></div>`;
  }

  function parseLatLon(latS, lonS) {
    const lat = parseFloat(String(latS ?? '').replace(',', '.'));
    const lon = parseFloat(String(lonS ?? '').replace(',', '.'));
    return [lat, lon];
  }

  function makeMarker(idx) {
    const r = allRows[idx];
    const p = preproc[idx];
    let [lat, lon] = parseLatLon(r[COLS.lat], r[COLS.lon]);

    if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
      const info = UF_INFO[p.ufUpper];
      if (info) {
        [lat, lon] = info.c;
      } else {
        [lat, lon] = BRAZIL_CENTER;
      }
    }

    const m = L.marker([lat, lon], { title: r[COLS.escola] || '' });
    m.bindPopup(formatPopup(r), { maxWidth: 480 });
    return m;
  }

  function buildCheckboxes(container, values, name) {
    container.innerHTML = Array.from(values).sort().map(v => {
      const id = `${name}__${v}`;
      return `<label><input type="checkbox" name="${name}" value="${esc(v)}" id="${id}"><span>${esc(v)}</span></label>`;
    }).join('');
  }
  function getCheckedValues(name) {
    return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(i=>i.value);
  }

  function fillSelectOnce(selectEl, values, firstLabel="(todas)") {
    const prev = selectEl.value;
    selectEl.innerHTML = '';
    const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = firstLabel;
    selectEl.appendChild(opt0);
    Array.from(values).sort().forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v;
      selectEl.appendChild(o);
    });
    const inst = initTomSelect(selectEl, firstLabel);
    inst.sync();
    if (prev && values.has(prev)) inst.setValue(prev, true);
  }

  function rebuildMunicipiosForUF() {
    const selectedUFs = getCheckedValues('uf');
    const set = new Set();
    for (const p of preproc) {
      if (selectedUFs.length && !selectedUFs.includes(p.ufUpper)) continue;
      if (p.municipio) set.add(p.municipio);
    }
    if (!set.size) {
      for (const p of preproc) if (p.municipio) set.add(p.municipio);
    }
    const keep = ts[selects.municipio.id]?.getValue();
    selects.municipio.innerHTML = '';
    const opt0 = document.createElement('option'); opt0.value = ''; opt0.textContent = '(todos)';
    selects.municipio.appendChild(opt0);
    Array.from(set).sort().forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v;
      selects.municipio.appendChild(o);
    });
    ts[selects.municipio.id].sync();
    if (keep && set.has(keep)) ts[selects.municipio.id].setValue(keep, true); else ts[selects.municipio.id].clear(true);
  }

  function updateCounts() {
    const n = filteredIdx.length;
    countsEl.textContent = n ? `${n.toLocaleString()} resultado(s)` : '';
  }

  /***********************
   * WEB WORKER (inline)
   ***********************/
  const workerSrc = document.getElementById('filter-worker').textContent;
  const workerUrl = URL.createObjectURL(new Blob([workerSrc], { type: 'application/javascript' }));
  const worker = new Worker(workerUrl);
  worker.postMessage({ type: 'config', ufInfo: UF_INFO });

  worker.onmessage = (e) => {
    const {type} = e.data;
    if (type === 'loaded') {
      btnApply.disabled = false;
      btnClear.disabled = false;
    }
    if (type === 'filtered') {
      filteredIdx = e.data.idx || [];
      updateCounts();
      setProgress(filteredIdx.length ? `${filteredIdx.length.toLocaleString()} resultado(s)` : 'Nenhum resultado');
      renderFilteredMarkersChunked();
    }
  };

  /***********************
   * RENDER (chunked)
   ***********************/
  function renderFilteredMarkersChunked() {
    cluster.clearLayers();
    if (!filteredIdx.length) { exportBtn.disabled = true; return; }
    exportBtn.disabled = true;

    let i = 0;
    let firstBoundsDone = false;

    const addChunk = () => {
      const end = Math.min(i + CHUNK_SIZE_ADD, filteredIdx.length);
      const batch = [];
      for (; i < end; i++) {
        const idx = filteredIdx[i];
        const m = makeMarker(idx);
        if (m) batch.push(m);
      }
      if (batch.length) cluster.addLayers(batch);

      if (!firstBoundsDone && cluster.getLayers().length > 0) {
        try {
          const b = cluster.getBounds();
          if (b && b.isValid()) { map.fitBounds(b.pad(0.15), { maxZoom: 10 }); firstBoundsDone = true; }
        } catch(_) {}
      }

      if (i < filteredIdx.length) {
        setTimeout(addChunk, 0);
      } else {
        exportBtn.disabled = false;
        try {
          const bounds = cluster.getBounds();
          if (bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.2), { maxZoom: 10 });
        } catch(_) {}
      }
    };
    addChunk();
  }

  /***********************
   * LOAD CSV
   ***********************/
  csvFile.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    allRows = []; preproc = []; filteredIdx = [];
    cluster.clearLayers();
    setProgress('Carregando CSV…'); exportBtn.disabled = true;
    countsEl.textContent = '';
    checksUF.innerHTML = '';
    checksEtapas.innerHTML = '';
    checksOfertas.innerHTML = '';

    let total=0, lastUI=0;

    Papa.parse(file, {
      header: true, skipEmptyLines: true, chunkSize: 1024*1024,
      chunk: ({data}) => {
        const now = performance.now();
        for (const row of data) {
          allRows.push(row);

          const uf = String(row[COLS.uf] || '').trim();
          const ufUpper = uf.toUpperCase();
          const municipio = row[COLS.municipio] ? String(row[COLS.municipio]) : '';
          const etapasArr = (row[COLS.etapas] ? String(row[COLS.etapas]) : '')
            .split(',').map(s=>s.trim()).filter(Boolean);
          const ofertasArr = (row[COLS.ofertas] ? String(row[COLS.ofertas]) : '')
            .split(',').map(s=>s.trim()).filter(Boolean);

          // searchable lowercased concatenation
          const search = [
            row[COLS.escola], row[COLS.inep], row[COLS.uf], row[COLS.municipio],
            row[COLS.catAdm], row[COLS.localizacao], row[COLS.locDif], row[COLS.depAdm],
            row[COLS.catPriv], row[COLS.conveniada], row[COLS.regul], row[COLS.porte],
            row[COLS.etapas], row[COLS.ofertas], row[COLS.endereco], row[COLS.telefone]
          ].map(v => (v==null ? '' : String(v).toLowerCase())).join(' | ');

          preproc.push({
            uf, ufUpper, municipio,
            restricao: row[COLS.restricao] || '',
            catAdm: row[COLS.catAdm] || '',
            localizacao: row[COLS.localizacao] || '',
            locDif: row[COLS.locDif] || '',
            depAdm: row[COLS.depAdm] || '',
            catPriv: row[COLS.catPriv] || '',
            conveniada: row[COLS.conveniada] || '',
            regul: row[COLS.regul] || '',
            porte: row[COLS.porte] || '',
            etapasArr,       // arrays used for OR matching
            ofertasArr,
            search
          });
          total++;
        }
        if (now - lastUI > 200) {
          setProgress(`Lidos: ${total.toLocaleString()}`);
          lastUI = now;
        }
      },
      complete: () => {
        setProgress(`CSV carregado. Total: ${total.toLocaleString()}. Aplique filtros para visualizar no mapa.`);

        // uniques
        const setUF        = new Set(preproc.map(p => p.ufUpper).filter(Boolean));
        const setMun       = new Set(preproc.map(p => p.municipio).filter(Boolean));
        const setCatAdm    = new Set(preproc.map(p => p.catAdm).filter(Boolean));
        const setLocal     = new Set(preproc.map(p => p.localizacao).filter(Boolean));
        const setLocDif    = new Set(preproc.map(p => p.locDif).filter(Boolean));
        const setRestr     = new Set(preproc.map(p => p.restricao).filter(Boolean));
        const setDep       = new Set(preproc.map(p => p.depAdm).filter(Boolean));
        const setCatPriv   = new Set(preproc.map(p => p.catPriv).filter(Boolean));
        const setConv      = new Set(preproc.map(p => p.conveniada).filter(Boolean));
        const setRegul     = new Set(preproc.map(p => p.regul).filter(Boolean));
        const setPorte     = new Set(preproc.map(p => p.porte).filter(Boolean));

        // UF checkboxes (all unchecked by default)
        buildCheckboxes(checksUF, setUF, 'uf');

        // Municipio depends on UF selection
        fillSelectOnce(selects.municipio, setMun, "(todos)");

        fillSelectOnce(selects.catAdm, setCatAdm);
        fillSelectOnce(selects.localizacao, setLocal);
        fillSelectOnce(selects.locDif, setLocDif);
        fillSelectOnce(selects.restricao, setRestr);
        fillSelectOnce(selects.depAdm, setDep);
        fillSelectOnce(selects.catPriv, setCatPriv);
        fillSelectOnce(selects.conveniada, setConv);
        fillSelectOnce(selects.regul, setRegul);
        fillSelectOnce(selects.porte, setPorte, "(todos)");

        const setEtapas = new Set(); const setOfertas = new Set();
        for (const p of preproc) {
          p.etapasArr.forEach(v => setEtapas.add(v));
          p.ofertasArr.forEach(v => setOfertas.add(v));
        }
        buildCheckboxes(checksEtapas, setEtapas, 'etapas');
        buildCheckboxes(checksOfertas, setOfertas, 'ofertas');

        // UI ready
        btnApply.disabled = false; btnClear.disabled = false;

        // Region auto → UFs (no button)
        ts[selects.regiao.id].on('change', (value) => {
          const boxes = Array.from(document.querySelectorAll('input[name="uf"]'));
          // Uncheck all first
          boxes.forEach(b => (b.checked = false));
          if (value) {
            for (const box of boxes) {
              const info = UF_INFO[box.value];
              if (info && info.reg === value) box.checked = true;
            }
          }
          rebuildMunicipiosForUF();
        });

        // If a UF is toggled manually, clear region selection
        checksUF.addEventListener('change', (e) => {
          if (e.target && e.target.name === 'uf') {
            ts[selects.regiao.id].clear(true);
            rebuildMunicipiosForUF();
          }
        });

        // Send rows to worker
        worker.postMessage({ type: 'load', preproc });
      },
      error: (err) => { console.error(err); setProgress('Erro ao ler CSV: ' + err); }
    });
  });

  /***********************
   * FILTERS
   ***********************/
  function getCriteria() {
    const selVal = (el) => (ts[el.id] ? ts[el.id].getValue() : el.value);
    return {
      regiao:    selVal(selects.regiao),             // exact string
      uf:        getCheckedValues('uf'),             // array of UFs (UPPER)
      municipio: selVal(selects.municipio),
      catAdm:    selVal(selects.catAdm),
      localizacao: selVal(selects.localizacao),
      locDif:    selVal(selects.locDif),
      restricao: selVal(selects.restricao),
      depAdm:    selVal(selects.depAdm),
      catPriv:   selVal(selects.catPriv),
      conveniada:selVal(selects.conveniada),
      regul:     selVal(selects.regul),
      porte:     selVal(selects.porte),
      etapas:    getCheckedValues('etapas'),  // OR
      ofertas:   getCheckedValues('ofertas'), // OR
      text:      (txtSearch.value || '').trim()
    };
  }

  document.getElementById('applyFilters').addEventListener('click', () => {
    if (!preproc.length) return;
    setProgress('Filtrando…');
    exportBtn.disabled = true;
    worker.postMessage({type:'filter', criteria: getCriteria()});
  });

  document.getElementById('clearFilters').addEventListener('click', () => {
    // Clear selects (including region)
    for (const key in selects) { ts[selects[key].id]?.clear(true); }
    // Uncheck all UFs / etapas / ofertas
    for (const cb of document.querySelectorAll('input[name="uf"], input[name="etapas"], input[name="ofertas"]')) cb.checked = false;

    txtSearch.value = "";
    rebuildMunicipiosForUF();
    filteredIdx = [];
    cluster.clearLayers();
    updateCounts();
    exportBtn.disabled = true;
    setProgress('Filtros limpos. Clique "Aplicar" para ver resultados.');
  });

  document.getElementById('filterText').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('applyFilters').click(); });

  /***********************
   * EXPORT CSV
   ***********************/
  exportBtn.addEventListener('click', () => {
    if (!filteredIdx.length) return;
    const headers = Object.values(COLS);
    const rows = filteredIdx.map(i => {
      const r = allRows[i];
      const out = {}; headers.forEach(h => out[h] = r[h] ?? '');
      return out;
    });
    const csv = Papa.unparse(rows, { columns: headers });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `escolas_filtradas_${Date.now()}.csv`;
    document.body.appendChild(a); a.click();
    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
  });
</script>
</body>
</html>
